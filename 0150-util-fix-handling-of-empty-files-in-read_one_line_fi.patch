From 822decbb65b09fbbddde87c75996238ce642e475 Mon Sep 17 00:00:00 2001
From: Lennart Poettering <lennart@poettering.net>
Date: Sat, 11 Feb 2012 00:27:12 +0100
Subject: [PATCH] util: fix handling of empty files in read_one_line_file()

https://bugs.freedesktop.org/show_bug.cgi?id=45362
(cherry picked from commit 4099a281bb1e7bbb941c55de559dbfb9abf5897b)
---
 src/util.c |   17 ++++++++++++-----
 1 files changed, 12 insertions(+), 5 deletions(-)

diff --git a/src/util.c b/src/util.c
index d942d31..6065463 100644
--- a/src/util.c
+++ b/src/util.c
@@ -704,15 +704,22 @@ int read_one_line_file(const char *fn, char **line) {
         assert(fn);
         assert(line);
 
-        if (!(f = fopen(fn, "re")))
+        f = fopen(fn, "re");
+        if (!f)
                 return -errno;
 
-        if (!(fgets(t, sizeof(t), f))) {
-                r = feof(f) ? -EIO : -errno;
-                goto finish;
+        if (!fgets(t, sizeof(t), f)) {
+
+                if (ferror(f)) {
+                        r = -errno;
+                        goto finish;
+                }
+
+                t[0] = 0;
         }
 
-        if (!(c = strdup(t))) {
+        c = strdup(t);
+        if (!c) {
                 r = -ENOMEM;
                 goto finish;
         }
